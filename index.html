<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Familie Financi√´n</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0e17;--card:#141824;--card2:#1a1f2e;--border:#1f2842;--border2:#2a3450;--gold:#e6b84a;--green:#3ecf8e;--red:#e05252;--blue:#4f9cf9;--purple:#a78bfa;--text:#e5e9f2;--dim:#8892a8;--faint:#4a5568;--r:14px;}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Inter,sans-serif;background:var(--bg);color:var(--text);font-size:13px;line-height:1.5}
.loading{position:fixed;inset:0;background:rgba(10,14,23,.95);z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px}
.loading.hidden{display:none}
.spinner{width:48px;height:48px;border:4px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.hdr{display:flex;justify-content:space-between;padding:20px 32px;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:200;background:rgba(10,14,23,.95);backdrop-filter:blur(12px)}
.hdr-title{font-family:'Playfair Display',serif;font-size:26px;color:var(--gold)}
.hdr-sub{font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px}
.hdr-right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.tab-group{display:flex;background:var(--card);border:1px solid var(--border);border-radius:8px;overflow:hidden}
.tab{padding:7px 16px;font-size:12px;font-weight:500;cursor:pointer;border:none;background:none;color:var(--dim);transition:.15s}
.tab.active{background:var(--gold);color:#0a0e17;font-weight:600}
select{background:var(--card);border:1px solid var(--border);color:var(--text);padding:8px 14px;border-radius:8px;font-size:12px;cursor:pointer;font-weight:500}
.btn{padding:8px 16px;border:none;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;transition:.2s}
.btn-gold{background:var(--gold);color:#0a0e17}
.btn-outline{background:transparent;border:1px solid var(--border2);color:var(--dim)}
.btn-outline:hover{border-color:var(--gold);color:var(--text)}
.main{padding:24px 32px;max-width:1800px;margin:0 auto}
.view{display:none}
.view.active{display:block}
.hero{background:linear-gradient(135deg,rgba(230,184,74,.08),rgba(79,156,249,.05));border:1px solid rgba(230,184,74,.2);border-radius:var(--r);padding:32px;margin-bottom:24px}
.hero-title{font-family:'Playfair Display',serif;font-size:32px;color:var(--gold);margin-bottom:8px}
.compare-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:24px}
.compare-card{background:rgba(20,24,36,.6);border:1px solid var(--border);border-radius:var(--r);padding:24px;transition:.2s}
.compare-card:hover{border-color:var(--gold);transform:translateY(-2px)}
.compare-label{font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px;font-weight:600}
.compare-year{font-size:13px;margin-bottom:16px}
.compare-value{font-family:'Playfair Display',serif;font-size:36px;margin-bottom:16px}
.compare-value.pos{color:var(--green)}
.compare-value.neg{color:var(--red)}
.compare-rate{display:flex;gap:6px;align-items:center;margin-bottom:12px}
.rate-value{font-size:14px;font-weight:700}
.rate-value.high{color:var(--green)}
.rate-value.mid{color:var(--gold)}
.rate-value.low{color:var(--red)}
.rate-label{font-size:11px;color:var(--faint)}
.compare-meta{font-size:12px;color:var(--faint);line-height:1.8}
.meta-value{color:var(--dim);font-weight:500}
.compare-delta{font-size:12px;padding:6px 12px;border-radius:6px;display:inline-block;font-weight:600;margin-top:12px}
.compare-delta.up{background:rgba(62,207,142,.15);color:var(--green)}
.compare-delta.dn{background:rgba(224,82,82,.15);color:var(--red)}
.section{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:28px;margin-bottom:20px}
.section-header{display:flex;justify-content:space-between;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid var(--border)}
.section-title{font-size:16px;font-weight:700}
.section-subtitle{font-size:12px;color:var(--dim);margin-top:4px}
.actions{display:flex;flex-direction:column;gap:20px}
.action-card{background:var(--card2);border:1px solid var(--border2);border-radius:var(--r);padding:20px;position:relative}
.action-number{position:absolute;top:16px;left:16px;width:32px;height:32px;border-radius:50%;background:var(--gold);color:#0a0e17;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px}
.action-content{margin-left:48px}
.action-title{font-size:14px;font-weight:700;margin-bottom:8px}
.action-detail{font-size:12px;color:var(--dim);margin-bottom:6px;line-height:1.6}
.action-target{background:rgba(230,184,74,.1);border:1px solid rgba(230,184,74,.2);padding:10px 14px;border-radius:6px;margin-top:10px;font-size:12px}
.action-impact{font-weight:700;color:var(--gold)}
.projection{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:16px}
.proj-card{background:var(--card2);border:1px solid var(--border2);border-radius:8px;padding:18px}
.proj-label{font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:.7px;margin-bottom:12px;font-weight:600}
.proj-row{display:flex;justify-content:space-between;margin-bottom:8px;font-size:12px}
.proj-row-label{color:var(--dim)}
.proj-row-value{font-weight:600}
.proj-highlight{font-size:16px;font-weight:700;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)}
.proj-highlight.pos{color:var(--green)}
.proj-highlight.neg{color:var(--red)}
.kdv-countdown{background:linear-gradient(135deg,rgba(167,139,250,.1),rgba(79,156,249,.08));border:1px solid rgba(167,139,250,.2);border-radius:var(--r);padding:24px;margin-top:20px}
.kdv-title{font-size:15px;font-weight:700;color:var(--purple);margin-bottom:16px}
.kdv-milestone{margin-bottom:16px}
.kdv-date{font-size:13px;font-weight:700;margin-bottom:4px}
.kdv-impact{font-size:12px;color:var(--dim)}
.kdv-question{background:rgba(20,24,36,.6);padding:14px;border-radius:8px;margin-top:16px;font-size:12px;border-left:3px solid var(--gold);line-height:1.6}
.kpi-row{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:18px}
.kpi{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:16px 18px;position:relative;overflow:hidden;transition:.2s}
.kpi:hover{border-color:var(--gold);transform:translateY(-2px)}
.kpi::after{content:"";position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--gold)}
.kpi.g::after{background:var(--green)}
.kpi.r::after{background:var(--red)}
.kpi.b::after{background:var(--blue)}
.kpi-lbl{font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:.7px;margin-bottom:7px}
.kpi-val{font-family:'Playfair Display',serif;font-size:26px;margin-bottom:5px}
.kpi-val.pos{color:var(--green)}
.kpi-val.neg{color:var(--red)}
.kpi-delta{font-size:10px}
.kpi-delta.up{color:var(--green)}
.kpi-delta.dn{color:var(--red)}
.kpi-delta.neu{color:var(--dim)}
.alert{display:flex;gap:10px;padding:12px 16px;border-radius:var(--r);margin-bottom:18px;border:1px solid}
.alert-text{font-size:12px;line-height:1.6}
.advisor{background:linear-gradient(135deg,rgba(212,168,67,.07),rgba(79,156,249,.04));border:1px solid rgba(212,168,67,.2);border-radius:var(--r);padding:20px;margin-bottom:14px}
.adv-title{font-family:'Playfair Display',serif;font-size:18px;color:var(--gold);margin-bottom:14px}
.insights{display:flex;flex-direction:column;gap:8px}
.insight{display:flex;gap:10px;padding:11px 13px;border-radius:8px;background:rgba(11,14,22,.6);border-left:3px solid var(--gold)}
.insight.danger{border-color:var(--red)}
.insight.ok{border-color:var(--green)}
.insight.info{border-color:var(--blue)}
.insight-text{font-size:12px;line-height:1.6;color:var(--dim)}
.insight-text strong{color:var(--text)}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px}
canvas{max-height:240px}
@media(max-width:1200px){.kpi-row{grid-template-columns:repeat(3,1fr)}.grid2,.projection,.compare-grid{grid-template-columns:1fr}}
</style>
</head>
<body>

<div class="loading" id="loading">
<div class="spinner"></div>
<div style="color:var(--dim);font-size:14px">Google Sheets laden...</div>
</div>

<div class="hdr">
<div>
<div class="hdr-title">Familie Financi√´n ‚Äî Samen</div>
<div class="hdr-sub" id="hdr-sub">Dashboard ¬∑ Data laden...</div>
</div>
<div class="hdr-right">
<div class="tab-group">
<button class="tab active" onclick="switchView('monthly')">üìÖ Maand</button>
<button class="tab" onclick="switchView('yearly')">üìä Jaar</button>
</div>
<select id="year-select" onchange="S.year=this.value;render()"></select>
<button class="btn btn-outline" onclick="loadData()" title="Ververs data">üîÑ Ververs</button>
</div>
</div>

<div class="main">
<div class="view active" id="monthly-view">
<div class="hero">
<div class="hero-title" id="hero-title">December 2025</div>
<div class="compare-grid" id="compare-grid"></div>
</div>
<div class="section">
<div class="section-header"><div><div class="section-title">üéØ Acties voor de Komende Maand</div><div class="section-subtitle">Concrete, meetbare stappen</div></div></div>
<div class="actions" id="actions"></div>
</div>
<div class="section">
<div class="section-header"><div><div class="section-title">üìä Jaar Projecties</div><div class="section-subtitle">Waar eindig je dit jaar?</div></div></div>
<div class="projection" id="projection"></div>
<div class="kdv-countdown" id="kdv-countdown"></div>
</div>
</div>

<div class="view" id="yearly-view">
<div class="kpi-row" id="kpi-row"></div>
<div class="alert" id="alert-bar"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#e05252" stroke-width="2"><path d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"/></svg><div class="alert-text"></div></div>
<div class="advisor"><div class="adv-title">üßô Financieel Advies</div><div class="insights" id="insights"></div></div>
<div class="grid2">
<div class="section"><div class="section-header"><div class="section-title">Maandelijkse Cashflow</div></div><canvas id="chart-cf"></canvas></div>
<div class="section"><div class="section-header"><div class="section-title">Uitgaven Verdeling</div></div><canvas id="chart-donut"></canvas></div>
</div>
</div>
</div>

<script>
const SHEET_ID="1MS_4az-9_OdeG0PxONFoJxDBR5lmS_JbgaFpS--rCds";
let DB={Samen:{annual:{}}},S={year:"2025",month:"12",view:"monthly"},CH={};
const MO=["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Aug","Sep","Okt","Nov","Dec"];
const MO_FULL=["Januari","Februari","Maart","April","Mei","Juni","Juli","Augustus","September","Oktober","November","December"];
const fa=n=>"‚Ç¨"+Math.abs(n||0).toLocaleString("nl-NL",{maximumFractionDigits:0});
const fp=n=>(n||0).toFixed(1)+"%";
const fc=(n,s=true)=>{if(!n)return"‚Äì";const a=Math.abs(n);return(s?(n<0?"-":"+"):"")+(a>=1000?"‚Ç¨"+(a/1000).toFixed(1)+"K":"‚Ç¨"+a.toFixed(0))};
const ann=y=>(DB.Samen.annual||{})[String(y)]||{};
const mon=(y,m)=>((DB.Samen["monthly"+y])||{})[String(m)]||{};
const varDetail=(y,m)=>((DB.Samen["varDetail"+y])||{})[String(m)]||{};
const exp=d=>(d.vaste||0)+(d.huishoud||0)+(d.res||0)+(d.vrij||0);
const yrs=()=>Object.keys(DB.Samen.annual||{}).sort();

async function loadData(){
document.getElementById('loading').classList.remove('hidden');
try{
const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=Transacties`;
const r=await fetch(url);
const t=await r.text();
const j=t.match(/google\.visualization\.Query\.setResponse\(([\s\S\w]+)\)/)[1];
const d=JSON.parse(j);
if(!d.table||!d.table.rows)throw new Error("No data");

console.log("First row data:", d.table.rows[0]);
console.log("Column headers:", d.table.cols.map((c,i)=>({index:i, label:c.label})));

// FIXED: Column indices (0-based, so subtract 1 from letter position)
// A=0, B=1, C=2, D=3, E=4, F=5, G=6, H=7, I=8, J=9, K=10, L=11, M=12
const rows=d.table.rows.map(r=>{
const c=r.c||[];
return{
Year:c[7]?.v,        // Column H (index 7)
Month:c[8]?.v,       // Column I (index 8)  
Hoofdcategorie:c[4]?.v,  // Column E (index 4)
Subcategorie:c[3]?.v,    // Column D (index 3)
Amount:parseFloat(c[11]?.v||0)  // Column L (index 11)
}}).filter(r=>r.Year&&r.Month&&r.Hoofdcategorie&&!isNaN(r.Amount));

console.log("Sample parsed rows:", rows.slice(0,5));
console.log(`Total rows parsed: ${rows.length}`);

buildDB(rows);
updateYearSel();
updateSub();
const ly=Math.max(...yrs().map(Number));
const lmd=DB.Samen["monthly"+ly]||{};
const lm=Object.keys(lmd).length>0?Math.max(...Object.keys(lmd).map(Number)):12;
S.year=String(ly);S.month=String(lm);
render();
document.getElementById('loading').classList.add('hidden');
}catch(e){
console.error("Load error:", e);
document.getElementById('loading').innerHTML=`<div style="color:var(--red);max-width:500px;text-align:center;line-height:1.6">‚ùå Fout bij laden<br><br>${e.message}<br><br>Controleer of sheet gedeeld is als "Iedereen met de link kan bekijken"<br><br><button class="btn btn-gold" onclick="location.reload()">Probeer opnieuw</button></div>`;
}}

function buildDB(rows){
const cm={"Inkomsten":"income","Vaste lasten":"vaste","Huishoudelijke uitgaven":"huishoud","Reserveringsuitgaven":"res","Vrijetijdsuitgaven":"vrij"};
const vc=["Huishoudelijke uitgaven","Vrijetijdsuitgaven","Reserveringsuitgaven"];
DB.Samen={annual:{}};
rows.forEach(r=>{
const y=String(r.Year),m=String(r.Month),cat=r.Hoofdcategorie,sub=r.Subcategorie||"",amt=r.Amount,ck=cm[cat];
if(!ck)return;
if(!DB.Samen.annual[y])DB.Samen.annual[y]={income:0,vaste:0,huishoud:0,res:0,vrij:0,net:0};
DB.Samen.annual[y][ck]=(DB.Samen.annual[y][ck]||0)+amt;
DB.Samen.annual[y].net=["income","vaste","huishoud","res","vrij"].reduce((s,k)=>s+(DB.Samen.annual[y][k]||0),0);
const mk="monthly"+y;
if(!DB.Samen[mk])DB.Samen[mk]={};
if(!DB.Samen[mk][m])DB.Samen[mk][m]={income:0,vaste:0,huishoud:0,res:0,vrij:0,net:0};
DB.Samen[mk][m][ck]=(DB.Samen[mk][m][ck]||0)+amt;
DB.Samen[mk][m].net=["income","vaste","huishoud","res","vrij"].reduce((s,k)=>s+(DB.Samen[mk][m][ck]||0),0);
if(vc.includes(cat)&&sub){
const vk="varDetail"+y;
if(!DB.Samen[vk])DB.Samen[vk]={};
if(!DB.Samen[vk][m])DB.Samen[vk][m]={};
DB.Samen[vk][m][sub]=(DB.Samen[vk][m][sub]||0)+amt;
}
});
console.log("Built DB:", DB);
console.log("Jan 2026:", mon(2026,1));
}

function updateYearSel(){
const sel=document.getElementById('year-select');
sel.innerHTML=yrs().sort().reverse().map(y=>`<option value="${y}" ${y===S.year?'selected':''}>${y}</option>`).join('');
}

function updateSub(){
const ly=Math.max(...yrs().map(Number));
const lmd=DB.Samen["monthly"+ly]||{};
const lm=Object.keys(lmd).length>0?Math.max(...Object.keys(lmd).map(Number)):12;
document.getElementById("hdr-sub").textContent=`Dashboard ¬∑ Data t/m ${MO_FULL[lm-1]} ${ly}`.toUpperCase();
}

function switchView(v){
S.view=v;
document.querySelectorAll(".tab").forEach((t,i)=>t.classList.toggle("active",["monthly","yearly"][i]===v));
document.getElementById("monthly-view").classList.toggle("active",v==="monthly");
document.getElementById("yearly-view").classList.toggle("active",v==="yearly");
render();
}

function render(){
S.view==="monthly"?renderMonthly():renderYearly();
}

function renderMonthly(){
const y=+S.year,m=+S.month;
const curr=mon(y,m),prev1=mon(y-1,m),prev2=mon(y-2,m);
document.getElementById("hero-title").textContent=MO_FULL[m-1]+" "+y;
const cards=[{label:"Dit jaar",year:y,data:curr},{label:"Vorig jaar",year:y-1,data:prev1,delta:curr.net-(prev1.net||0)},{label:"2 jaar geleden",year:y-2,data:prev2,delta:curr.net-(prev2.net||0)}];
let html="";
cards.forEach(c=>{
if(!c.data||!Object.keys(c.data).length){html+=`<div class="compare-card"><div class="compare-label">${c.label}</div><div class="compare-year">${MO_FULL[m-1]} ${c.year}</div><div style="color:var(--faint);padding:40px 0;text-align:center">Geen data</div></div>`;return}
const net=c.data.net||0,inc=c.data.income||0,ex=Math.abs(exp(c.data)),rate=inc>0?(net/inc*100):0,rc=rate>=15?'high':rate>=5?'mid':'low';
html+=`<div class="compare-card"><div class="compare-label">${c.label}</div><div class="compare-year">${MO_FULL[m-1]} ${c.year}</div><div class="compare-value ${net>=0?'pos':'neg'}">${fc(net,false)}</div>${c.delta!==undefined?`<div class="compare-delta ${c.delta>=0?'up':'dn'}">${c.delta>=0?'‚Üë':'‚Üì'} ${fa(Math.abs(c.delta))} beter</div>`:''}<div class="compare-rate"><span class="rate-value ${rc}">${fp(rate)}</span><span class="rate-label">spaarquote</span></div><div class="compare-meta">Inkomsten: <span class="meta-value">${fa(inc)}</span><br>Uitgaven: <span class="meta-value">${fa(ex)}</span></div></div>`;
});
document.getElementById("compare-grid").innerHTML=html;
const cv=varDetail(y,m),pv=varDetail(y-1,m);
let acts=[],vt={};
for(const[cat,amt]of Object.entries(cv||{}))if(cat!=="Persoonlijke overboeking")vt[cat]=amt;
const sorted=Object.entries(vt).sort((a,b)=>a[1]-b[1]);
if(sorted.length>0){
const[tc,ta]=sorted[0],pa=(pv||{})[tc]||ta,tgt=Math.abs(pa*.9),sav=Math.abs(ta)-tgt;
acts.push({title:`${tc} modereren`,detail:`${MO_FULL[m-1]} was ${fa(Math.abs(ta))}`,target:`Target voor ${MO_FULL[m%12]}: max ${fa(tgt)} (10% reductie)`,impact:fa(sav)});
}
const cr=curr.income>0?(curr.net/curr.income*100):0,gap=15-cr;
if(gap>0){
const mg=curr.income*gap/100;
acts.push({title:"Momentum naar 15% spaarquote",detail:`Huidige maand: ${fp(cr)} ¬∑ Target: 15.0%`,target:`Gap: nog ${fa(mg)}/maand om 15% te halen`,impact:fa(mg*12)+"/jaar"});
}
document.getElementById("actions").innerHTML=acts.map((a,i)=>`<div class="action-card"><div class="action-number">${i+1}</div><div class="action-content"><div class="action-title">${a.title}</div><div class="action-detail">${a.detail}</div><div class="action-target">${a.target} ¬∑ Besparing: <span class="action-impact">${a.impact}</span></div></div></div>`).join('');
const s1i=curr.income*12,s1e=Math.abs(exp(curr))*12,s1n=s1i-s1e,s1r=s1i>0?(s1n/s1i*100):0;
const s3i=116000,s3e=s3i*.85,s3n=s3i*.15,g=s3e-s1e;
document.getElementById("projection").innerHTML=`<div class="proj-card"><div class="proj-label">Scenario 1: Herhaal ${MO[m-1]}</div><div class="proj-row"><span class="proj-row-label">Inkomen</span><span class="proj-row-value">${fa(s1i)}</span></div><div class="proj-row"><span class="proj-row-label">Uitgaven</span><span class="proj-row-value">${fa(s1e)}</span></div><div class="proj-highlight ${s1n>=0?'pos':'neg'}">${fc(s1n,false)} netto (${fp(s1r)})</div></div><div class="proj-card" style="border-color:var(--gold)"><div class="proj-label">üéØ Target: 15% spaarquote</div><div class="proj-row"><span class="proj-row-label">Inkomen</span><span class="proj-row-value">${fa(s3i)}</span></div><div class="proj-row"><span class="proj-row-label">Uitgaven</span><span class="proj-row-value">${fa(s3e)}</span></div><div class="proj-highlight pos">${fc(s3n,false)} netto (15.0%)</div><div style="font-size:11px;color:var(--gold);margin-top:10px;font-weight:600">Gap: ${fa(Math.abs(g))}/jaar minder uitgeven</div></div><div class="proj-card"><div class="proj-label">Om 15% te halen</div><div style="font-size:12px;line-height:1.7"><div style="margin-bottom:8px">Maandelijks ${fa(Math.abs(g/12))} minder uitgeven</div><div style="font-size:11px;color:var(--dim)">‚Ä¢ Horeca max ‚Ç¨250<br>‚Ä¢ Shoppen max ‚Ç¨100<br>‚Ä¢ Inventaris max ‚Ç¨200<br>= ~‚Ç¨450/mnd = 48% of gap</div></div></div>`;
const cd=new Date(y,m-1,1),j26=new Date(2026,6,1),s29=new Date(2029,8,1);
const mj=Math.max(0,Math.round((j26-cd)/(1e3*60*60*24*30))),ms=Math.max(0,Math.round((s29-cd)/(1e3*60*60*24*30)));
if(y>=2025&&y<=2027){
const sm=(y===2025&&m>=11)||(y===2026&&m<=7);
let kh=`<div class="kdv-title">üë∂ Kinderopvang Transitie${sm?' <span style="background:rgba(224,82,82,.2);color:var(--red);font-size:11px;padding:3px 10px;border-radius:6px;font-weight:600">SURVIVAL MODE</span>':''}</div>`;
if(mj>0)kh+=`<div class="kdv-milestone"><div class="kdv-date">Juli 2026 (over ${mj} maanden)</div><div class="kdv-impact">Oudste naar BSO ‚Üí ~‚Ç¨400/mnd vrijval</div></div>`;
if(ms>12)kh+=`<div class="kdv-milestone"><div class="kdv-date">Sept 2029 (over ${Math.round(ms/12)} jaar)</div><div class="kdv-impact">Jongste naar basisschool ‚Üí ‚Ç¨15.6K/jaar totale KDV vrijval</div></div>`;
if(sm)kh+=`<div class="kdv-question">‚ö†Ô∏è Nov 2025 - Juli 2026 = zwaarste periode qua KDV kosten.<br>Focus: Alle positieve netto is een WIN.</div>`;
document.getElementById("kdv-countdown").innerHTML=kh;
}else{document.getElementById("kdv-countdown").innerHTML="";}
}

function renderYearly(){
const d=ann(S.year),p=ann(+S.year-1),te=exp(d),pe=exp(p),rate=d.income>0?d.net/d.income*100:0,pr=p.income>0?(p.net||0)/p.income*100:null,rc=pr!==null?rate-pr:null,hp=Object.keys(p).length>0;
const kpis=[
{l:"Jaarinkomen",v:fa(d.income),vc:d.income>=(p.income||0)?"pos":"",d:hp?(d.income>=(p.income||0)?"‚ñ≤ ":"‚ñº ")+fa(Math.abs(d.income-(p.income||0)))+" vs "+(+S.year-1):"Eerste jaar",dc:d.income>=(p.income||0)?"up":"dn",t:"g"},
{l:"Totale uitgaven",v:fa(Math.abs(te)),vc:"",d:hp?(Math.abs(te)<=Math.abs(pe)?"‚ñº ":"‚ñ≤ ")+fa(Math.abs(Math.abs(te)-Math.abs(pe)))+" vs "+(+S.year-1):"",dc:Math.abs(te)<=Math.abs(pe)?"up":"dn",t:"r"},
{l:"Netto resultaat",v:fc(d.net),vc:d.net>=0?"pos":"neg",d:d.net>=0?"Positief saldo ‚úì":"Negatief saldo ‚úó",dc:d.net>=0?"up":"dn",t:d.net>=0?"g":"r"},
{l:"Spaarquote",v:fp(rate),vc:rate>=10?"pos":rate>=0?"":"neg",d:rc!==null?(rc>=0?"‚ñ≤ ":"‚ñº ")+Math.abs(rc).toFixed(1)+"% vs "+(+S.year-1):"Eerste jaar",dc:rc>=0?"up":"dn",t:rate>=10?"g":rate>=0?"":"r"},
{l:"Vaste lasten % inkomen",v:d.income>0?Math.round(Math.abs(d.vaste)/d.income*100)+"%":"--",vc:"",d:fa(Math.abs(d.vaste||0))+" per jaar",dc:"neu",t:"b"}
];
document.getElementById("kpi-row").innerHTML=kpis.map(k=>`<div class="kpi ${k.t}"><div class="kpi-lbl">${k.l}</div><div class="kpi-val ${k.vc}">${k.v}</div><div class="kpi-delta ${k.dc}">${k.d}</div></div>`).join("");
let col,bg,tc,msg;
if(rate<0){col="rgba(224,82,82,.3)";bg="rgba(224,82,82,.08)";tc="#f8a0a0";}
else if(rate<10){col="rgba(212,168,67,.3)";bg="rgba(212,168,67,.06)";tc="#fde68a";}
else{col="rgba(62,207,142,.3)";bg="rgba(62,207,142,.06)";tc="#86efac";}
if(rate<0)msg=`<strong>Spaarquote ${S.year}: ${fp(rate)}</strong> ‚Äî meer uitgegeven dan verdiend.`;
else if(rate<10)msg=`<strong>Spaarquote ${S.year}: ${fp(rate)}</strong> ‚Äî laag, aanbevolen is minimaal 15‚Äì20%.`;
else msg=`<strong>Spaarquote ${S.year}: ${fp(rate)}</strong> ‚Äî gezond niveau, goed bezig!`;
const el=document.getElementById("alert-bar");
el.style.borderColor=col;el.style.background=bg;el.querySelector(".alert-text").style.color=tc;el.querySelector(".alert-text").innerHTML=msg;
const items=[
{t:rate<0?"danger":rate<10?"warn":"ok",ic:rate<0?"üî¥":rate<10?"üü°":"üü¢",tx:`<strong>Spaarquote ${fp(rate)}</strong> ‚Äî ${rate<0?"Meer uitgegeven dan verdiend.":rate<10?"Laag. Met inkomen "+fa(d.income)+" is "+fa(Math.round(d.income*.15))+" (15%) sparen per jaar haalbaar.":"Goed! Overweeg het surplus te investeren."}`},
{t:"danger",ic:"üè†",tx:`<strong>Wonen + KDV: ~‚Ç¨47.6K/jr</strong> ‚Äî Hypotheek (~‚Ç¨31.9K) + kinderopvang (~‚Ç¨15.7K). KDV is tijdelijk.`},
{t:"info",ic:"üí°",tx:`<strong>Quickwins:</strong> Persoonlijke overboeking (~‚Ç¨12K/jr), Shoppen, Horeca = ~‚Ç¨21K be√Ønvloedbaar.`},
{t:"info",ic:"üéØ",tx:`<strong>Automatiseer sparen:</strong> Zet ‚Ç¨${Math.round(d.income*.15/12).toLocaleString("nl-NL")}/mnd automatisch opzij.`}
];
document.getElementById("insights").innerHTML=items.map(i=>`<div class="insight ${i.t}"><span style="font-size:15px;flex-shrink:0;margin-top:1px">${i.ic}</span><span class="insight-text">${i.tx}</span></div>`).join("");
const md=DB.Samen["monthly"+S.year]||{},labels=[],inc=[],ex=[],net=[];
for(let m=1;m<=12;m++){const d=md[String(m)];if(!d)continue;labels.push(MO[m-1]);inc.push(d.income||0);const e=Math.abs(exp(d));ex.push(e);net.push((d.income||0)-e);}
const ctx=document.getElementById("chart-cf").getContext("2d");
if(CH.cf)CH.cf.destroy();
CH.cf=new Chart(ctx,{type:"bar",data:{labels,datasets:[{label:"Inkomsten",data:inc,backgroundColor:"rgba(62,207,142,.65)",borderRadius:3,order:2},{label:"Uitgaven",data:ex,backgroundColor:"rgba(224,82,82,.65)",borderRadius:3,order:2},{label:"Netto",data:net,type:"line",borderColor:"#d4a843",borderWidth:2,pointRadius:3,pointBackgroundColor:"#d4a843",fill:false,tension:.3,order:1}]},options:{responsive:true,maintainAspectRatio:true,interaction:{mode:"index",intersect:false},plugins:{legend:{labels:{color:"#7a8ba8",font:{size:10},boxWidth:10,padding:12}},tooltip:{backgroundColor:"#161d2e",borderColor:"#1f2d45",borderWidth:1,titleColor:"#dde3f0",bodyColor:"#7a8ba8",padding:9}},scales:{x:{grid:{color:"rgba(31,45,69,.5)"},ticks:{color:"#7a8ba8",font:{size:10}}},y:{grid:{color:"rgba(31,45,69,.5)"},ticks:{color:"#7a8ba8",font:{size:10},callback:v=>"‚Ç¨"+(v/1000).toFixed(0)+"K"}}}}});
const vals=[Math.abs(d.vaste||0),Math.abs(d.huishoud||0),Math.abs(d.res||0),Math.abs(d.vrij||0)];
const ctx2=document.getElementById("chart-donut").getContext("2d");
if(CH.donut)CH.donut.destroy();
CH.donut=new Chart(ctx2,{type:"doughnut",data:{labels:["Vaste lasten","Huishoudelijk","Reserveringen","Vrijetijd"],datasets:[{data:vals,backgroundColor:["#4f9cf9","#d4a843","#a78bfa","#3ecf8e"],borderColor:"#161d2e",borderWidth:3,hoverOffset:6}]},options:{responsive:true,maintainAspectRatio:true,cutout:"70%",plugins:{legend:{position:"right",labels:{color:"#7a8ba8",font:{size:10},padding:12,boxWidth:10}},tooltip:{backgroundColor:"#161d2e",borderColor:"#1f2d45",borderWidth:1,titleColor:"#dde3f0",bodyColor:"#7a8ba8",padding:9}}}});
}

document.addEventListener("DOMContentLoaded",()=>loadData());
</script>
</body>
</html>
