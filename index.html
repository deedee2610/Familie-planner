<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Familie Financieel Dashboard</title>
<style>
  :root {
    --bg: #0f1117; --surface: #1a1d27; --surface2: #22263a; --border: #2e3250;
    --text: #e8eaf6; --muted: #7b80a8;
    --green: #4caf76; --green-bg: rgba(76,175,118,0.12);
    --gold: #f5a623; --gold-bg: rgba(245,166,35,0.12);
    --red: #ef5350; --red-bg: rgba(239,83,80,0.12);
    --blue: #5c9eff; --blue-bg: rgba(92,158,255,0.12);
    --purple: #9c7af5;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; font-size: 14px; line-height: 1.5; }

  /* â”€â”€ LAYOUT â”€â”€ */
  .header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px; }
  .header h1 { font-size: 18px; font-weight: 700; }
  .header h1 span { color: var(--blue); }
  .header-right { display: flex; align-items: center; gap: 12px; }
  .header-meta { color: var(--muted); font-size: 12px; }
  .loading-bar { display: none; height: 3px; background: linear-gradient(90deg, var(--blue), var(--purple)); animation: slide 1.2s infinite; }
  @keyframes slide { 0%{background-position:-200px} 100%{background-position:200px} }
  .container { max-width: 1400px; margin: 0 auto; padding: 20px 24px; }
  .section-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; color: var(--muted); margin-bottom: 12px; margin-top: 28px; }

  /* â”€â”€ CARDS â”€â”€ */
  .cards-4 { display: grid; grid-template-columns: repeat(4,1fr); gap: 14px; }
  .cards-3 { display: grid; grid-template-columns: repeat(3,1fr); gap: 14px; }
  .cards-2 { display: grid; grid-template-columns: repeat(2,1fr); gap: 14px; }
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 18px; }
  .card.highlight { border-color: var(--blue); background: linear-gradient(135deg, var(--surface) 0%, rgba(92,158,255,0.06) 100%); }
  .card-label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 6px; }
  .card-value { font-size: 26px; font-weight: 700; }
  .green { color: var(--green); } .red { color: var(--red); } .gold { color: var(--gold); } .blue { color: var(--blue); }
  .card-sub { font-size: 12px; color: var(--muted); margin-top: 4px; }
  .divider { border: none; border-top: 1px solid var(--border); margin: 10px 0; }
  .metric-row { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; }
  .metric-label { font-size: 12px; color: var(--muted); }
  .metric-val { font-size: 13px; font-weight: 600; }

  /* â”€â”€ VERDICT BANNER â”€â”€ */
  .verdict { background: var(--green-bg); border: 1px solid var(--green); border-radius: 12px; padding: 14px 18px; display: flex; align-items: center; gap: 12px; margin-bottom: 4px; }
  .verdict.warn { background: var(--gold-bg); border-color: var(--gold); }
  .verdict-icon { font-size: 20px; }
  .verdict-text { font-size: 14px; font-weight: 600; }
  .verdict-text .hl { color: var(--green); }
  .verdict.warn .verdict-text .hl { color: var(--gold); }

  /* â”€â”€ PROGRESS â”€â”€ */
  .progress-bar-wrap { background: var(--surface2); border-radius: 6px; height: 10px; margin: 8px 0 4px; overflow: hidden; }
  .progress-bar { height: 100%; border-radius: 6px; transition: width 0.6s ease; }
  .progress-bar.green { background: var(--green); }
  .progress-bar.gold { background: var(--gold); }
  .progress-bar.red { background: var(--red); }
  .row-between { display: flex; justify-content: space-between; align-items: center; }

  /* â”€â”€ PULSE GRID â”€â”€ */
  .pulse-grid { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 14px; }
  .pulse-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }

  /* â”€â”€ TREND GRID â”€â”€ */
  .trend-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 14px; }
  .chart-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 18px; }
  .chart-title { font-size: 13px; font-weight: 600; margin-bottom: 2px; }
  .chart-sub { font-size: 11px; color: var(--muted); margin-bottom: 10px; }

  /* â”€â”€ ALERTS â”€â”€ */
  .alerts-grid { display: flex; flex-direction: column; gap: 10px; }
  .alert-item { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 14px 16px; display: flex; align-items: flex-start; gap: 12px; }
  .alert-item.warn { border-left: 3px solid var(--gold); }
  .alert-item.good { border-left: 3px solid var(--green); }
  .alert-item.danger { border-left: 3px solid var(--red); }
  .alert-item.info { border-left: 3px solid var(--blue); }
  .alert-icon { font-size: 18px; line-height: 1.4; }
  .alert-title { font-size: 13px; font-weight: 600; }
  .alert-desc { font-size: 12px; color: var(--muted); margin-top: 2px; }

  /* â”€â”€ BENCHMARKS â”€â”€ */
  .bench-row { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--border); }
  .bench-row:last-child { border-bottom: none; }
  .bench-label { width: 190px; font-size: 12px; color: var(--muted); flex-shrink: 0; }
  .bench-bar-wrap { flex: 1; background: var(--surface2); border-radius: 4px; height: 8px; position: relative; overflow: visible; }
  .bench-bar-you { height: 8px; border-radius: 4px; background: var(--blue); position: absolute; top: 0; }
  .bench-bar-nibud { width: 2px; height: 14px; background: var(--gold); position: absolute; top: -3px; }
  .bench-val { width: 70px; text-align: right; font-size: 12px; font-weight: 600; }
  .bench-nibud-val { width: 70px; text-align: right; font-size: 12px; color: var(--gold); }

  /* â”€â”€ ACTION PANEL â”€â”€ */
  .action-grid { display: flex; flex-direction: column; gap: 10px; }
  .action-item { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 14px 16px; }
  .action-title { font-size: 13px; font-weight: 700; color: var(--blue); }
  .action-desc { font-size: 12px; color: var(--text); margin-top: 4px; }
  .action-impact { font-size: 12px; color: var(--green); margin-top: 6px; font-weight: 600; }

  /* â”€â”€ BUDGET TABLE â”€â”€ */
  .data-table { width: 100%; border-collapse: collapse; }
  .data-table th { text-align: left; padding: 8px 10px; font-size: 11px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--muted); border-bottom: 1px solid var(--border); }
  .data-table td { padding: 8px 10px; font-size: 13px; border-bottom: 1px solid rgba(46,50,80,0.4); }
  .data-table tr:last-child td { border-bottom: none; }
  .tag { display: inline-block; padding: 2px 8px; border-radius: 20px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
  .tag.green { background: var(--green-bg); color: var(--green); }
  .tag.red { background: var(--red-bg); color: var(--red); }
  .tag.gold { background: var(--gold-bg); color: var(--gold); }

  /* â”€â”€ VASTE LASTEN ALERT â”€â”€ */
  .vaste-alert { background: var(--gold-bg); border: 1px solid var(--gold); border-radius: 8px; padding: 10px 14px; font-size: 12px; color: var(--gold); margin-top: 10px; }

  /* â”€â”€ LOADING / ERROR â”€â”€ */
  #loadingMsg { text-align: center; padding: 60px 20px; color: var(--muted); font-size: 16px; }
  #errorMsg { display: none; background: var(--red-bg); border: 1px solid var(--red); border-radius: 10px; padding: 20px; margin: 20px; color: var(--red); font-size: 13px; }
  #dashboard { display: none; }

  footer { text-align: center; color: var(--muted); font-size: 11px; padding: 24px; margin-top: 20px; }

  @media (max-width: 900px) {
    .cards-4 { grid-template-columns: repeat(2,1fr); }
    .pulse-grid, .trend-grid { grid-template-columns: 1fr; }
    .cards-2 { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<div class="header">
  <h1>Familie <span>Financieel</span> Dashboard</h1>
  <div class="header-right">
    <div class="header-meta" id="headerMeta">Data laden...</div>
    <button onclick="loadData()" style="background:var(--blue);border:none;color:#fff;padding:6px 14px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600;">â†» Vernieuwen</button>
  </div>
</div>
<div class="loading-bar" id="loadingBar" style="display:block;"></div>

<div id="loadingMsg">ğŸ“Š Transacties laden uit Google Sheets...</div>
<div id="errorMsg"></div>
<div id="dashboard" class="container"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SHEET_ID = '1MS_4az-9_OdeG0PxONFoJxDBR5lmS_JbgaFpS--rCds';
const SHEET_NAME = 'Transacties';
const SAVINGS_TARGET_PCT = 0.15;

const MONTHS_NL = ['Jan','Feb','Mrt','Apr','Mei','Jun','Jul','Aug','Sep','Okt','Nov','Dec'];
const YEAR_COLORS = { 2023:'#4a7fc1', 2024:'#f5a623', 2025:'#9c7af5', 2026:'#4caf76' };

// Category definitions â€” map raw sheet labels to dashboard groups
const CAT_MAP = {
  'Boodschappen':           { group:'Huishoudelijk', label:'Boodschappen',        trend:'rolling' },
  'Horeca & Activiteiten':  { group:'Vrijetijd',     label:'Horeca & Activiteit', trend:'rolling' },
  'Verzorging':             { group:'Verzorging',    label:'Verzorging',           trend:'rolling' },
  'Shoppen':                { group:'Shoppen',       label:'Shoppen',              trend:'rolling' },
  'Vakantie':               { group:'Reservering',   label:'Vakantie',             trend:'same-month' },
  'Cadeaus':                { group:'Vrijetijd',     label:'Cadeaus',              trend:'same-month' },
  'Inventaris & onderhoud': { group:'Reservering',   label:'Inventaris/Klussen',   trend:'same-month' },
  'Dieren':                 { group:'Huishoudelijk', label:'Dieren',               trend:'rolling' },
  'Kinderen':               { group:'Huishoudelijk', label:'Kind',                 trend:'rolling' },
  'Vervoer':                { group:'Vervoer',       label:'Vervoer',              trend:'rolling' },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOAD DATA FROM GOOGLE SHEETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadData() {
  document.getElementById('loadingBar').style.display = 'block';
  document.getElementById('loadingMsg').style.display = 'block';
  document.getElementById('dashboard').style.display = 'none';
  document.getElementById('errorMsg').style.display = 'none';
  document.getElementById('headerMeta').textContent = 'Data laden...';

  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;

  try {
    const resp = await fetch(url);
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const csv = await resp.text();
    if (!csv || csv.startsWith('<!DOCTYPE')) throw new Error('Sheet niet publiek toegankelijk. Zet delen aan: Iedereen met de link â†’ Viewer.');
    const parsed = parseTransacties(csv);
    renderDashboard(parsed);
    document.getElementById('headerMeta').textContent = `Bijgewerkt: ${new Date().toLocaleDateString('nl-NL', {day:'numeric',month:'long',year:'numeric'})} Â· ${parsed.totalRows} transacties`;
  } catch(e) {
    document.getElementById('errorMsg').style.display = 'block';
    document.getElementById('errorMsg').innerHTML = `
      <strong>âš ï¸ Kan data niet laden</strong><br><br>
      ${e.message}<br><br>
      <strong>Oplossing:</strong> Ga naar je Google Sheet â†’ Delen (rechtsboven) â†’ Wijzig naar "Iedereen met de link kan bekijken" â†’ Sla op.<br><br>
      <small style="opacity:0.7;">Technische fout: ${e.message}</small>`;
    document.getElementById('loadingMsg').style.display = 'none';
    document.getElementById('headerMeta').textContent = 'Laad fout';
  } finally {
    document.getElementById('loadingBar').style.display = 'none';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARSE CSV TRANSACTIES
// Verwacht kolommen: Info, Laagste categorie, Notes,
//   Subcategorie, Hoofdcategorie, Label, Account,
//   Year, Month, Date, Info1, Amount, Info2
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseCSVLine(line) {
  const result = [];
  let cur = '', inQuote = false;
  for (let i = 0; i < line.length; i++) {
    const c = line[i];
    if (c === '"') { inQuote = !inQuote; }
    else if (c === ',' && !inQuote) { result.push(cur.trim()); cur = ''; }
    else { cur += c; }
  }
  result.push(cur.trim());
  return result;
}

function parseAmount(s) {
  // Dutch format: "-1.234,56" or "-31,9" or "-20"
  if (!s) return 0;
  s = s.replace(/['"â‚¬\s]/g, '');
  s = s.replace(/\./g, '').replace(',', '.');
  return parseFloat(s) || 0;
}

function parseTransacties(csv) {
  // Normalize line endings
  const lines = csv.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n').filter(l => l.trim());
  if (lines.length < 2) throw new Error('Geen data gevonden in sheet. Controleer of het werkblad "Transacties" heet en data bevat.');

  const headers = parseCSVLine(lines[0]).map(h => h.replace(/['"]/g,'').trim());
  
  // Column indices based on actual sheet structure
  const iSubCat  = headers.findIndex(h => h === 'Subcategorie');
  const iHoofCat = headers.findIndex(h => h === 'Hoofdcategorie');
  const iYear    = headers.findIndex(h => h === 'Year');
  const iMonth   = headers.findIndex(h => h === 'Month');
  const iAmount  = headers.findIndex(h => h === 'Amount');
  const iLaagste = headers.findIndex(h => h === 'Laagste categorie');

  if (iAmount < 0 || iYear < 0 || iMonth < 0) {
    throw new Error(
      `Verwachte kolommen niet gevonden.\n` +
      `Gevonden: ${headers.join(', ')}\n` +
      `Verwacht: Year, Month, Amount, Subcategorie, Hoofdcategorie`
    );
  }

  // â”€â”€ Aggregate by (year, month, subcategorie) and (year, month, hoofdcategorie)
  const byYMSub  = {};   // [year][month][subcategorie] = total
  const byYMHoof = {};   // [year][month][hoofdcategorie] = total
  let totalRows = 0;

  for (let i = 1; i < lines.length; i++) {
    const cols = parseCSVLine(lines[i]);
    if (cols.length < 3) continue;

    const year  = parseInt(cols[iYear]);
    const month = parseInt(cols[iMonth]);
    if (!year || !month || year < 2020 || year > 2030) continue;

    const amount = parseAmount(cols[iAmount]);
    if (isNaN(amount) || amount === 0) continue;

    const subCat  = iSubCat  >= 0 ? cols[iSubCat].replace(/['"]/g,'').trim()  : 'Overig';
    const hoofCat = iHoofCat >= 0 ? cols[iHoofCat].replace(/['"]/g,'').trim() : 'Overig';

    if (!byYMSub[year])  byYMSub[year]  = {};
    if (!byYMSub[year][month])  byYMSub[year][month]  = {};
    byYMSub[year][month][subCat] = (byYMSub[year][month][subCat] || 0) + amount;

    if (!byYMHoof[year]) byYMHoof[year] = {};
    if (!byYMHoof[year][month]) byYMHoof[year][month] = {};
    byYMHoof[year][month][hoofCat] = (byYMHoof[year][month][hoofCat] || 0) + amount;

    totalRows++;
  }

  const years = Object.keys(byYMHoof).map(Number).sort();
  if (!years.length) throw new Error('Geen geldige transacties gevonden. Controleer de Amount kolom (verwacht Nederlands formaat, bijv. "-31,90").');

  // â”€â”€ Net savings per month = sum of all 5 hoofdcategorieÃ«n
  // Persoonlijke overboeking zit in Huishoudelijke uitgaven en wordt meegeteld
  // (dit is zakgeld naar persoonlijke rekeningen, telt als uitgave van gezamenlijke rekening)
  const HOOF_CATS = ['Inkomsten','Vaste lasten','Huishoudelijke uitgaven','Reserveringsuitgaven','Vrijetijdsuitgaven'];

  const savings = {};
  years.forEach(yr => {
    savings[yr] = [];
    for (let m = 1; m <= 12; m++) {
      const monthData = byYMHoof[yr]?.[m];
      if (!monthData) { savings[yr].push(null); continue; }
      const net = HOOF_CATS.reduce((s, h) => s + (monthData[h] || 0), 0);
      savings[yr].push(net);
    }
  });

  const annualSavings = {};
  years.forEach(yr => {
    annualSavings[yr] = savings[yr].reduce((s, v) => s + (v || 0), 0);
  });

  // â”€â”€ Determine latest month with data
  let currentYear = 0, currentMonth = 0;
  years.forEach(yr => {
    for (let m = 12; m >= 1; m--) {
      if (byYMHoof[yr]?.[m] && (yr > currentYear || (yr === currentYear && m > currentMonth))) {
        currentYear = yr; currentMonth = m;
      }
    }
  });

  return {
    byYMSub, byYMHoof, savings, annualSavings, years,
    currentYear, currentMonth, totalRows,
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard(d) {
  document.getElementById('loadingMsg').style.display = 'none';
  const el = document.getElementById('dashboard');
  el.style.display = 'block';

  const { savings, annualSavings, years, currentYear, currentMonth, byYMSub, byYMHoof } = d;

  // Helpers: look up by (year, month, category name)
  const getSub  = (yr, mo, key) => byYMSub[yr]?.[mo]?.[key]  ?? 0;
  const getHoof = (yr, mo, key) => byYMHoof[yr]?.[mo]?.[key] ?? 0;

  const cy = currentYear, cm = currentMonth;
  const prevYears = [cy-1, cy-2, cy-3].filter(y => years.includes(y));

  const fmt = v => 'â‚¬\u00a0' + Math.abs(Math.round(v)).toLocaleString('nl-NL');
  const fmtDiff = v => (v >= 0 ? '+' : 'âˆ’') + 'â‚¬\u00a0' + Math.abs(Math.round(v)).toLocaleString('nl-NL');

  // â”€â”€ Current month
  const curSav    = savings[cy]?.[cm-1] ?? 0;
  const curIncVal = getHoof(cy, cm, 'Inkomsten');
  const curExp    = curIncVal - curSav;
  const curSavPct = curIncVal > 0 ? (curSav / curIncVal * 100) : 0;

  // â”€â”€ YTD
  let ytdSav = 0, ytdInc = 0;
  for (let m = 1; m <= cm; m++) {
    ytdSav += savings[cy]?.[m-1] ?? 0;
    ytdInc += getHoof(cy, m, 'Inkomsten');
  }
  const ytdSavPct = ytdInc > 0 ? (ytdSav / ytdInc * 100) : 0;
  const projSav   = cm > 0 ? (ytdSav / cm) * 12 : 0;
  const projInc   = cm > 0 ? (ytdInc / cm) * 12 : 0;
  const projExp   = projInc - projSav;
  const targetSav = projInc * SAVINGS_TARGET_PCT;
  const targetGap = ytdSav - (ytdInc * SAVINGS_TARGET_PCT);

  // â”€â”€ Same-month prev years
  const prevMonthSav = savings[cy]?.[cm-2] ?? null;
  const sameMthPrev  = prevYears.map(py => {
    const inc = getHoof(py, cm, 'Inkomsten');
    const sav = savings[py]?.[cm-1] ?? null;
    return { year: py, sav, inc: inc || null, exp: (inc && sav !== null) ? inc - sav : null };
  });

  const vsPrevMonth    = prevMonthSav !== null ? curSav - prevMonthSav : null;
  const vsSameLastYear = sameMthPrev[0]?.sav !== null ? curSav - (sameMthPrev[0]?.sav ?? 0) : null;

  // â”€â”€ Vaste lasten alert (>â‚¬50 verschil vs zelfde maand vorig jaar)
  const vlCur  = getHoof(cy,   cm, 'Vaste lasten');
  const vlPrev = getHoof(cy-1, cm, 'Vaste lasten');
  const vlDiff = vlCur - vlPrev;
  const showVLAlert = Math.abs(vlDiff) > 50;

  // â”€â”€ Annual ratios
  const annualVL = {}, annualInc = {};
  years.forEach(yr => {
    let vl = 0, inc = 0;
    for (let m = 1; m <= 12; m++) {
      vl  += getHoof(yr, m, 'Vaste lasten');
      inc += getHoof(yr, m, 'Inkomsten');
    }
    annualVL[yr] = vl; annualInc[yr] = inc;
  });

  // â”€â”€ Chart categories (Subcategorie names from CSV)
  const CHART_CATS = [
    { key:'Boodschappen',          label:'Boodschappen',          emoji:'ğŸ›’' },
    { key:'Horeca & Activiteiten', label:'Horeca & Activiteiten', emoji:'ğŸ½ï¸' },
    { key:'Verzorging',            label:'Verzorging',            emoji:'ğŸ’†' },
    { key:'Shoppen',               label:'Shoppen',               emoji:'ğŸ›ï¸' },
    { key:'Vakantie & Camper',     label:'Vakantie & Camper',     emoji:'âœˆï¸' },
    { key:'Cadeaus',               label:'Cadeaus',               emoji:'ğŸ' },
  ];

  // â”€â”€ Budget table (Subcategorie keys)
  const BUDGET_CATS = [
    { cat:'Huishoudelijk', sub:'Boodschappen',           key:'Boodschappen'             },
    { cat:'Huishoudelijk', sub:'Dieren',                 key:'Dieren'                   },
    { cat:'Huishoudelijk', sub:'Kinderen',               key:'Kinderen'                 },
    { cat:'Huishoudelijk', sub:'Overig huishouden',      key:'Overig huishouden'        },
    { cat:'Huishoudelijk', sub:'Persoonlijke overb.',    key:'Persoonlijke overboeking' },
    { cat:'Shoppen',       sub:'Shoppen',                key:'Shoppen'                  },
    { cat:'Verzorging',    sub:'Verzorging',             key:'Verzorging'               },
    { cat:'Vervoer',       sub:'Vervoer',                key:'Vervoer'                  },
    { cat:'Vrijetijd',     sub:'Horeca & Activiteiten',  key:'Horeca & Activiteiten'    },
    { cat:'Vrijetijd',     sub:'Cadeaus',                key:'Cadeaus'                  },
    { cat:'Vrijetijd',     sub:'Entertainment abo',      key:'Entertainment abo'        },
    { cat:'Vrijetijd',     sub:'Vakantie & Camper',      key:'Vakantie & Camper'        },
    { cat:'Reservering',   sub:'Inventaris/Klussen',     key:'Inventaris & onderhoud'   },
  ];
  const budgetRows = BUDGET_CATS.map(r => ({
    ...r,
    a: Math.abs(getSub(cy,   cm, r.key)),
    b: Math.abs(getSub(cy-1, cm, r.key)),
  }));

  // â”€â”€ Alerts
  const alerts = [];
  CHART_CATS.forEach(({ key, label }) => {
    const curVal = Math.abs(getSub(cy, cm, key));
    if (curVal === 0) return;
    let sum = 0, cnt = 0;
    for (let m = 1; m <= 12; m++) {
      const v = Math.abs(getSub(cy-1, m, key));
      if (v > 0) { sum += v; cnt++; }
    }
    if (!cnt) return;
    const avg  = sum / cnt;
    const diff = curVal - avg;
    const pct  = avg > 0 ? diff / avg * 100 : 0;
    if (Math.abs(pct) > 15) alerts.push({ cat: label, key, curVal, avg, diff, pct });
  });
  alerts.sort((a,b) => b.pct - a.pct);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // HTML RENDER
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const savColor = curSav >= 0 ? (curSavPct >= 15 ? 'green' : curSavPct >= 5 ? 'gold' : 'red') : 'red';

  const verdictGood = vsSameLastYear === null || vsSameLastYear >= 0;
  const verdictHtml = `
    <div class="verdict ${verdictGood ? '' : 'warn'}">
      <div class="verdict-icon">${verdictGood ? 'âœ…' : 'âš ï¸'}</div>
      <div class="verdict-text">
        ${vsPrevMonth !== null ? `Je hebt <span class="hl">${fmtDiff(vsPrevMonth)}</span> ${vsPrevMonth >= 0 ? 'meer' : 'minder'} gespaard dan vorige maand` : 'Eerste maand van het jaar'}${vsSameLastYear !== null ? `, en <span class="hl">${fmtDiff(vsSameLastYear)}</span> ${vsSameLastYear >= 0 ? 'meer' : 'minder'} dan ${MONTHS_NL[cm-1]} ${cy-1}` : ''}.
      </div>
    </div>`;

  const monthCards = [
    { label: `${MONTHS_NL[cm-1]} ${cy} (nu)`, sav: curSav, pct: curSavPct, inc: curIncVal, exp: curExp, hi: true },
    ...sameMthPrev.map(p => ({
      label: `${MONTHS_NL[cm-1]} ${p.year}`,
      sav: p.sav, pct: p.inc > 0 ? p.sav/p.inc*100 : null,
      inc: p.inc, exp: p.exp, hi: false
    }))
  ];

  const monthCardsHtml = monthCards.map(c => {
    if (c.sav === null) return `<div class="card"><div class="card-label">${c.label}</div><div style="color:var(--muted);margin-top:8px;">Geen data</div></div>`;
    const pc = c.pct !== null ? c.pct.toFixed(1) : '?';
    const col = c.sav < 0 ? 'red' : c.pct >= 15 ? 'green' : c.pct >= 5 ? 'gold' : 'red';
    return `<div class="card ${c.hi ? 'highlight' : ''}">
      <div class="card-label">${c.label}</div>
      <div class="card-value ${col}">${fmt(c.sav)}</div>
      <div class="card-sub">${pc}% spaarquote</div>
      <hr class="divider">
      <div class="metric-row"><span class="metric-label">Inkomsten</span><span class="metric-val">${c.inc !== null ? fmt(c.inc) : 'â€”'}</span></div>
      <div class="metric-row"><span class="metric-label">Uitgaven</span><span class="metric-val">${c.exp !== null ? fmt(c.exp) : 'â€”'}</span></div>
    </div>`;
  }).join('');

  const vlAlertHtml = showVLAlert ? `
    <div class="vaste-alert">
      âš¡ <strong>Vaste Lasten afwijking:</strong> ${MONTHS_NL[cm-1]} ${cy} (${fmt(Math.abs(vlCur))}) vs ${MONTHS_NL[cm-1]} ${cy-1} (${fmt(Math.abs(vlPrev))}) â€” verschil <strong>${fmtDiff(vlDiff)}</strong>. Controleer welke post is gewijzigd.
    </div>` : '';

  const savPctBarW = Math.min(Math.max(ytdSavPct / SAVINGS_TARGET_PCT / 100 * 100, 2), 100);
  const savPctBarCol = ytdSavPct >= 15 ? 'green' : ytdSavPct >= 5 ? 'gold' : 'red';

  const annualRows = years.slice(-4).map(yr => {
    const tot = annualSavings[yr] ?? 0;
    const inc = annualInc[yr] ?? 0;
    const pct = inc > 0 ? (tot/inc*100).toFixed(1) : '?';
    const col = tot >= 0 && +pct >= 15 ? 'green' : tot >= 0 ? 'gold' : 'red';
    return `<div class="metric-row"><span class="metric-label">${yr}${yr === cy ? ' YTD' : ' totaal'}</span><span class="metric-val ${col}">${fmt(tot)} <small style="color:var(--muted);font-weight:400;">(${pct}%)</small></span></div>`;
  }).join('');

  const vlRatioRows = years.slice(-4).map(yr => {
    const vl  = Math.abs(annualVL[yr] ?? 0);
    const inc = annualInc[yr] ?? 1;
    const pct = (vl/inc*100).toFixed(1);
    const col = +pct > 55 ? 'red' : +pct > 48 ? 'gold' : '';
    return `<div class="metric-row"><span class="metric-label">${yr}</span><span class="metric-val ${col}">${pct}%</span></div>`;
  }).join('');

  // Charts HTML (canvas elements, filled by JS after render)
  const chartCardsHtml = CHART_CATS.map(({ key, label, emoji }) => {
    const curVal = Math.abs(getSub(cy, cm, key));
    let avg12 = 0, cnt = 0;
    for (let m = 1; m <= 12; m++) {
      const v = Math.abs(getSub(cy-1, m, key));
      if (v > 0) { avg12 += v; cnt++; }
    }
    avg12 = cnt > 0 ? avg12/cnt : 0;
    const diff = curVal - avg12;
    const diffCol = diff > 15 ? 'red' : diff < -15 ? 'green' : 'gold';
    return `<div class="chart-card">
      <div class="chart-title">${emoji} ${label}</div>
      <div class="chart-sub">${MONTHS_NL[cm-1]} ${cy}: ${fmt(curVal)} vs 12-mnd gem. ${fmt(avg12)}</div>
      <canvas id="chart_${key.replace(/[^a-z]/gi,'_')}" width="280" height="70"></canvas>
      <div style="margin-top:8px;font-size:12px;color:var(--${diffCol});">${diff > 0 ? 'â–²' : 'â–¼'} ${fmtDiff(diff)} t.o.v. gemiddelde</div>
    </div>`;
  }).join('');

  // Alerts HTML
  const alertsHtml = (() => {
    const items = [];
    // Structural: rising vaste lasten
    const vlRatio = Math.abs((annualVL[cy-1] ?? 0)) / (annualInc[cy-1] ?? 1) * 100;
    if (vlRatio > 50) items.push(`<div class="alert-item danger"><div class="alert-icon">ğŸ“‰</div><div>
      <div class="alert-title">Vaste lasten nemen meer dan ${vlRatio.toFixed(0)}% van inkomen in beslag</div>
      <div class="alert-desc">De structurele kosten (hypotheek, KDV, verzekeringen) stijgen sneller dan het inkomen. Dit is het grootste risico voor de spaarquote.</div>
    </div></div>`);
    // Category alerts
    alerts.filter(a => a.pct > 20).slice(0,3).forEach(a => {
      items.push(`<div class="alert-item warn"><div class="alert-icon">âš ï¸</div><div>
        <div class="alert-title">${a.cat}: ${fmt(a.curVal)} â€” ${a.pct.toFixed(0)}% boven 12-maands gemiddelde</div>
        <div class="alert-desc">Gemiddeld ${fmt(a.avg)}/maand, nu ${fmtDiff(a.diff)} hoger. Controleer of dit een eenmalige of structurele post is.</div>
      </div></div>`);
    });
    // Positive alerts
    alerts.filter(a => a.pct < -15).slice(0,2).forEach(a => {
      items.push(`<div class="alert-item good"><div class="alert-icon">âœ…</div><div>
        <div class="alert-title">${a.cat}: ${fmt(a.curVal)} â€” ${Math.abs(a.pct).toFixed(0)}% onder gemiddelde</div>
        <div class="alert-desc">Positieve afwijking: ${fmtDiff(a.diff)} t.o.v. ${fmt(a.avg)} gemiddeld.</div>
      </div></div>`);
    });
    // Seasonal
    items.push(`<div class="alert-item info"><div class="alert-icon">ğŸ“…</div><div>
      <div class="alert-title">Seizoenspatroon: houd rekening met hoge maanden</div>
      <div class="alert-desc">Historisch zijn mrtâ€“apr (reserveringen), junâ€“aug (vakantie) en novâ€“dec (cadeaus/uiteten) de duurste maanden. Plan vooruit.</div>
    </div></div>`);
    return items.join('');
  })();

  // Budget table HTML
  const budgetTableHtml = (() => {
    const cats = [...new Set(budgetRows.map(r => r.cat))];
    let html = '';
    let totA = 0, totB = 0;
    budgetRows.forEach(r => { totA += r.a; totB += r.b; });
    const totDiff = totA - totB;

    cats.forEach(cat => {
      const rows = budgetRows.filter(r => r.cat === cat);
      rows.forEach((r, i) => {
        const diff = r.a - r.b;
        const over = diff > 10, under = diff < -10;
        const diffCol = over ? 'var(--red)' : under ? 'var(--green)' : 'var(--muted)';
        const cellBg = over ? 'rgba(239,83,80,0.08)' : under ? 'rgba(76,175,118,0.08)' : '';
        const tag = over ? `<span class="tag red">â–² boven</span>` : under ? `<span class="tag green">â–¼ onder</span>` : `<span class="tag gold">â‰ˆ gelijk</span>`;
        html += `<tr style="background:${cellBg};">`;
        if (i === 0) html += `<td rowspan="${rows.length}" style="color:var(--muted);font-size:12px;vertical-align:top;padding-top:12px;">${cat}</td>`;
        html += `<td style="font-weight:500;">${r.sub}</td>`;
        html += `<td style="text-align:right;font-weight:600;">${r.a > 0 ? fmt(r.a) : '<span style="color:var(--muted);">â€”</span>'}</td>`;
        html += `<td style="text-align:right;color:var(--muted);">${r.b > 0 ? fmt(r.b) : '<span style="color:var(--muted);">â€”</span>'}</td>`;
        html += `<td style="text-align:right;color:${diffCol};font-weight:700;">${r.b === 0 && r.a === 0 ? '<span style="color:var(--muted);">â€”</span>' : (diff > 0 ? '+' : '') + fmt(diff).replace('â‚¬\u00a0','') + (diff >= 0 ? '' : '') }</td>`;
        html += `<td style="text-align:center;">${tag}</td></tr>`;
      });
      const cA = rows.reduce((s,r)=>s+r.a,0), cB = rows.reduce((s,r)=>s+r.b,0);
      const cD = cA - cB;
      html += `<tr style="background:var(--surface2);">
        <td></td><td style="font-size:11px;color:var(--muted);font-style:italic;">Subtotaal ${cat}</td>
        <td style="text-align:right;font-weight:700;">${fmt(cA)}</td>
        <td style="text-align:right;color:var(--muted);">${fmt(cB)}</td>
        <td style="text-align:right;color:${cD > 10 ? 'var(--red)' : cD < -10 ? 'var(--green)' : 'var(--muted)'};font-weight:700;">${cD > 0 ? '+' : ''}${fmt(Math.abs(cD)).replace('â‚¬\u00a0','')} â‚¬</td>
        <td></td></tr>`;
    });
    html += `<tr style="background:var(--surface2);border-top:2px solid var(--border);">
      <td style="font-weight:700;">TOTAAL</td><td style="font-weight:700;">Variabele uitgaven</td>
      <td style="text-align:right;font-weight:700;font-size:14px;">${fmt(totA)}</td>
      <td style="text-align:right;font-size:14px;color:var(--muted);">${fmt(totB)}</td>
      <td style="text-align:right;font-weight:700;font-size:14px;color:${totDiff > 20 ? 'var(--red)' : 'var(--green)' };">${totDiff > 0 ? '+' : ''}${fmt(Math.abs(totDiff)).replace('â‚¬\u00a0','')} â‚¬</td>
      <td style="text-align:center;">${totDiff > 20 ? '<span class="tag red">â–² boven</span>' : '<span class="tag green">â–¼ onder</span>'}</td></tr>`;
    return html;
  })();

  // â”€â”€ WRITE HTML
  el.innerHTML = `
    <!-- TOP: THIS MONTH -->
    <div class="section-label">ğŸ“… Deze Maand â€” ${MONTHS_NL[cm-1]} ${cy}</div>
    ${verdictHtml}
    <div class="cards-4" style="margin-top:14px;">${monthCardsHtml}</div>
    ${vlAlertHtml}

    <!-- YTD PULSE -->
    <div class="section-label">ğŸ“Š Year-to-Date Pulse â€” ${cy}</div>
    <div class="pulse-grid">
      <div class="pulse-card">
        <div class="card-label">Spaardoelstelling voortgang</div>
        <div class="row-between" style="margin-top:6px;">
          <span style="font-size:13px;">Actuele spaarquote YTD</span>
          <span style="font-weight:700;color:var(--${savPctBarCol});">${ytdSavPct.toFixed(1)}%</span>
        </div>
        <div class="progress-bar-wrap"><div class="progress-bar ${savPctBarCol}" style="width:${savPctBarW}%;"></div></div>
        <div class="row-between" style="font-size:11px;color:var(--muted);"><span>0%</span><span>Doel: ${(SAVINGS_TARGET_PCT*100).toFixed(0)}%</span></div>
        <hr class="divider">
        <div class="row-between">
          <div><div class="card-label">Gespaard YTD</div><div style="font-size:20px;font-weight:700;color:var(--${savPctBarCol});">${fmt(ytdSav)}</div></div>
          <div style="text-align:right;"><div class="card-label">Gap naar doel</div>
            <div style="font-size:20px;font-weight:700;color:var(--${targetGap >= 0 ? 'green' : 'red'});">${fmtDiff(targetGap)}</div>
            <div style="font-size:11px;color:var(--muted);">${targetGap >= 0 ? 'boven doel ğŸ‰' : 'onder doel'}</div>
          </div>
        </div>
        <hr class="divider">
        <div class="row-between">
          <div><div class="card-label">Geprojecteerd jaar (${cy})</div><div style="font-size:18px;font-weight:700;">${fmt(projSav)}</div><div style="font-size:11px;color:var(--muted);">bij huidig tempo</div></div>
          <div style="text-align:right;"><div class="card-label">Doel bij ${(SAVINGS_TARGET_PCT*100).toFixed(0)}%</div><div style="font-size:18px;font-weight:700;color:var(--green);">${fmt(targetSav)}</div></div>
        </div>
      </div>
      <div class="pulse-card">
        <div class="card-label">Burn Rate Analyse</div>
        <div style="font-size:20px;font-weight:700;margin:6px 0;">${fmt(curExp)}<span style="font-size:13px;font-weight:400;color:var(--muted);">/maand</span></div>
        <div style="font-size:12px;color:var(--muted);">Uitgaven ${MONTHS_NL[cm-1]} ${cy}</div>
        <hr class="divider">
        <div class="metric-row"><span class="metric-label">Geprojecteerde jaaruitgaven</span><span class="metric-val">${fmt(projExp)}</span></div>
        <div class="metric-row"><span class="metric-label">Vaste lasten (maand)</span><span class="metric-val">${fmt(Math.abs(getHoof(cy,cm,'Vaste lasten')))}</span></div>
        <div class="metric-row"><span class="metric-label">Variabele uitgaven</span><span class="metric-val gold">${fmt(Math.abs(curExp) - Math.abs(getHoof(cy,cm,'Vaste lasten')))}</span></div>
        <hr class="divider">
        <div style="font-size:12px;color:var(--muted);">Bij dit tempo geef je dit jaar <strong style="color:var(--gold);">${fmt(projExp)}</strong> uit.</div>
      </div>
      <div class="pulse-card">
        <div class="card-label">Jaar-op-jaar Nettobesparingen</div>
        <div style="margin-top:8px;">${annualRows}</div>
        <hr class="divider">
        <div class="card-label">Vaste lasten / Inkomen ratio</div>
        ${vlRatioRows}
      </div>
    </div>

    <!-- CATEGORY TRENDS -->
    <div class="section-label">ğŸ“ˆ Categorietrends</div>
    <div class="trend-grid">${chartCardsHtml}</div>

    <!-- ALERTS -->
    <div class="section-label">ğŸš¨ Watch These â€” Alerts & Signalen</div>
    <div class="alerts-grid">${alertsHtml}</div>

    <!-- SAVINGS CHART -->
    <div class="section-label">ğŸ“… Maandelijkse Nettobesparingen per Jaar</div>
    <div class="card">
      <canvas id="cSavingsMonthly" width="1200" height="180"></canvas>
      <div style="display:flex;gap:16px;margin-top:10px;font-size:11px;">
        ${years.slice(-4).map(yr => `<span><span style="color:${YEAR_COLORS[yr] || '#888'};">â–ˆ</span> ${yr}</span>`).join('')}
      </div>
    </div>

    <!-- BUDGET TABLE -->
    <div class="section-label">ğŸ“‹ Budget vs Actuals â€” ${MONTHS_NL[cm-1]} ${cy}</div>
    <div class="card" style="padding:0;overflow:hidden;">
      <div style="padding:14px 18px 10px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:6px;">
        <span style="font-size:13px;font-weight:600;">Maandoverzicht variabele uitgaven</span>
        <span style="font-size:11px;color:var(--muted);">Budget = ${MONTHS_NL[cm-1]} ${cy-1} actuals</span>
      </div>
      <table class="data-table">
        <thead><tr>
          <th style="width:140px;">Categorie</th><th>Subcategorie</th>
          <th style="text-align:right;">Actuals ${MONTHS_NL[cm-1]} '${String(cy).slice(2)}</th>
          <th style="text-align:right;">Budget (${MONTHS_NL[cm-1]} '${String(cy-1).slice(2)})</th>
          <th style="text-align:right;">Verschil</th>
          <th style="text-align:center;">Status</th>
        </tr></thead>
        <tbody>${budgetTableHtml}</tbody>
      </table>
    </div>

    <!-- BENCHMARKS -->
    <div class="section-label">ğŸ‡³ğŸ‡± Nibud Benchmarks</div>
    <div class="cards-2">
      <div class="card">
        <div class="card-label">Uitgaven vs. Nibud 2025 (2 volw. + 2 kinderen)</div>
        ${[
          { label:'Boodschappen/mnd',    you: Math.abs(getSub(cy,cm,'Boodschappen')),           nibud:490, max:800 },
          { label:'Horeca/mnd',          you: Math.abs(getSub(cy,cm,'Horeca & Activiteiten')),  nibud:290, max:600 },
          { label:'Kleding & Shoppen/mnd',you: Math.abs(getSub(cy,cm,'Shoppen')),               nibud:160, max:500 },
          { label:'Verzorging/mnd',      you: Math.abs(getSub(cy,cm,'Verzorging')),             nibud:130, max:300 },
          { label:'Vervoer/mnd',         you: Math.abs(getSub(cy,cm,'Vervoer')),                nibud:390, max:600 },
        ].map(b => `<div class="bench-row">
          <div class="bench-label">${b.label}</div>
          <div class="bench-bar-wrap">
            <div class="bench-bar-you" style="width:${Math.min(b.you/b.max*100,100).toFixed(1)}%;"></div>
            <div class="bench-bar-nibud" style="left:${(b.nibud/b.max*100).toFixed(1)}%;"></div>
          </div>
          <div class="bench-val" style="color:${b.you > b.nibud*1.1 ? 'var(--red)' : 'var(--green)'};">${fmt(b.you)}</div>
          <div class="bench-nibud-val">${fmt(b.nibud)}</div>
        </div>`).join('')}
        <div style="font-size:11px;color:var(--muted);margin-top:10px;"><span style="color:var(--blue);">â–ˆ</span> Jullie &nbsp;&nbsp;<span style="color:var(--gold);">â”‚</span> Nibud norm</div>
      </div>
      <div class="card">
        <div class="card-label">Inkomen & Sparen context</div>
        <div class="metric-row"><span class="metric-label">Geprojecteerd jaarinkomen</span><span class="metric-val">${fmt(projInc)}</span></div>
        <div class="metric-row"><span class="metric-label">Nibud mediaan 2 inkomens NL</span><span class="metric-val" style="color:var(--muted);">~â‚¬72.000</span></div>
        <hr class="divider">
        <div class="metric-row"><span class="metric-label">Spaarquote YTD ${cy}</span><span class="metric-val ${savPctBarCol}">${ytdSavPct.toFixed(1)}%</span></div>
        <div class="metric-row"><span class="metric-label">Nibud aanbevolen spaarquote</span><span class="metric-val" style="color:var(--muted);">10â€“15%</span></div>
        <div class="metric-row"><span class="metric-label">Jullie spaardoel</span><span class="metric-val green">${(SAVINGS_TARGET_PCT*100).toFixed(0)}%</span></div>
        <hr class="divider">
        <div style="font-size:12px;color:var(--muted);">De vaste lasten (hypotheek, KDV, verzekeringen) zijn de voornaamste reden dat de spaarquote onder doel blijft â€” niet de lifestyle-uitgaven.</div>
      </div>
    </div>

    <!-- ACTION PANEL -->
    <div class="section-label">âš¡ Actieplan â€” Volgende 30 Dagen</div>
    <div class="action-grid">
      ${alerts.filter(a=>a.pct>20).slice(0,3).map((a,i) => `
        <div class="action-item" style="border-color:var(--${i===0?'blue':i===1?'purple':'gold'});">
          <div class="action-title">ğŸ¥‡ Actie ${i+1}: Beheers ${a.cat} â€” nu ${fmt(a.curVal)}, doel max ${fmt(a.avg)}</div>
          <div class="action-desc">Je geeft ${fmtDiff(a.diff)} meer dan je 12-maands gemiddelde van ${fmt(a.avg)}. Stel een maandlimiet in en verplaats niet-urgente aankopen.</div>
          <div class="action-impact">ğŸ’° Als je terugkeert naar gemiddelde: bespaar ~${fmt(a.diff * 12)} dit jaar</div>
        </div>`).join('')}
      <div class="action-item">
        <div class="action-title">ğŸ“‹ Controleer kinderopvangtoeslag voor ${cy}</div>
        <div class="action-desc">Bij inkomensmutaties in ${cy-1} heb je mogelijk recht op een hogere toeslag. Check dit via het Toeslagenportaal.</div>
        <div class="action-impact">ğŸ’° Potentieel: â‚¬100â€“300/mnd extra = â‚¬1.200â€“3.600/jaar</div>
      </div>
    </div>

    <footer>Familie Financieel Dashboard Â· Data t/m ${MONTHS_NL[cm-1]} ${cy} Â· Nibud referentie: 2 volwassenen + 2 kinderen Â· Spaarquote doel: â‰¥${(SAVINGS_TARGET_PCT*100).toFixed(0)}% Â· <a href="https://docs.google.com/spreadsheets/d/${SHEET_ID}" target="_blank" style="color:var(--blue);">Open Google Sheet â†—</a></footer>
  `;

  // â”€â”€ DRAW CHARTS
  requestAnimationFrame(() => {
    drawSavingsChart(d, years, savings);
    CHART_CATS.forEach(({ key }) => {
      const id = 'chart_' + key.replace(/[^a-z]/gi,'_');
      drawLineChart(id, key, d, years, cy, cm);
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CANVAS DRAWING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawSavingsChart(d, years, savings) {
  const canvas = document.getElementById('cSavingsMonthly');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  canvas.width = canvas.parentElement.clientWidth - 36;
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);

  const drawYears = years.slice(-4);
  const allVals = drawYears.flatMap(yr => savings[yr].filter(v => v !== null));
  if (!allVals.length) return;
  const maxV = Math.max(...allVals, 100);
  const minV = Math.min(...allVals, 0);
  const range = maxV - minV || 1;
  const pad = { l:44, r:10, t:10, b:20 };
  const cW = W - pad.l - pad.r;
  const cH = H - pad.t - pad.b;
  const zeroY = pad.t + cH * (1 - (0 - minV) / range);

  // Grid lines
  [maxV, maxV*0.5, 0, minV*0.5, minV].forEach(v => {
    const y = pad.t + cH * (1 - (v - minV) / range);
    ctx.strokeStyle = v === 0 ? '#3a3f6b' : '#1e2234';
    ctx.lineWidth = v === 0 ? 1.5 : 0.5;
    ctx.beginPath(); ctx.moveTo(pad.l, y); ctx.lineTo(W - pad.r, y); ctx.stroke();
    ctx.fillStyle = '#7b80a8'; ctx.font = '9px sans-serif'; ctx.textAlign = 'right';
    ctx.fillText((v/1000).toFixed(0)+'k', pad.l-4, y+3);
  });

  const colW = cW / 12;
  const barW = colW / (drawYears.length + 0.5);

  drawYears.forEach((yr, yi) => {
    savings[yr].forEach((val, m) => {
      if (val === null) return;
      const h = Math.abs(val) / range * cH;
      const x = pad.l + m * colW + yi * barW;
      const yPos = val >= 0 ? zeroY - h : zeroY;
      ctx.fillStyle = YEAR_COLORS[yr] || '#888';
      ctx.globalAlpha = yr === Math.max(...drawYears) ? 1 : 0.65;
      ctx.fillRect(x, yPos, barW - 1, h);
    });
  });
  ctx.globalAlpha = 1;

  const MN = ['Jan','Feb','Mrt','Apr','Mei','Jun','Jul','Aug','Sep','Okt','Nov','Dec'];
  ctx.fillStyle = '#7b80a8'; ctx.font = '9px sans-serif'; ctx.textAlign = 'center';
  for (let m = 0; m < 12; m++) ctx.fillText(MN[m], pad.l + m * colW + colW/2, H - 4);
}

function drawLineChart(canvasId, catKey, d, years, cy, cm) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);

  const drawYears = years.slice(-4);
  const allVals = drawYears.flatMap(yr =>
    Array.from({length:12}, (_,m) => Math.abs(d.byYMSub[yr]?.[m+1]?.[catKey] ?? 0))
  );
  const maxV = Math.max(...allVals, 10);
  const pad = 4;

  drawYears.forEach(yr => {
    const isCur = yr === cy;
    const vals = Array.from({length: isCur ? cm : 12}, (_,m) =>
      Math.abs(d.byYMSub[yr]?.[m+1]?.[catKey] ?? 0));
    if (!vals.length) return;
    ctx.beginPath();
    ctx.strokeStyle = YEAR_COLORS[yr] || '#888';
    ctx.lineWidth = isCur ? 2.5 : 1.5;
    ctx.globalAlpha = isCur ? 1 : 0.35;
    ctx.lineJoin = 'round';
    vals.forEach((v, i) => {
      const x = pad + i * (W - pad*2) / 11;
      const y = H - pad - (v / maxV) * (H - pad*2);
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    });
    ctx.stroke();
    // dot at last point
    const li = vals.length - 1;
    const lx = pad + li * (W - pad*2) / 11;
    const ly = H - pad - (vals[li] / maxV) * (H - pad*2);
    ctx.beginPath();
    ctx.arc(lx, ly, isCur ? 4 : 2, 0, Math.PI*2);
    ctx.fillStyle = YEAR_COLORS[yr] || '#888';
    ctx.fill();
  });
  ctx.globalAlpha = 1;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// START
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
loadData();
window.addEventListener('resize', () => {
  // redraw savings chart on resize
  const btn = document.querySelector('button');
  // just redraw if data available
});
</script>
</body>
</html>
